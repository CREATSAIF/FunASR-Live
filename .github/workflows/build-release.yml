name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PYTHON_VERSION: '3.10'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install funasr modelscope sounddevice numpy PyYAML pynput pyperclip PyQt5 fastapi uvicorn websockets

      - name: Build GUI executable
        run: |
          pyinstaller --onefile --windowed --name FunASR-GUI `
            --add-data "config_realtime.yaml;." `
            --add-data "model.py;." `
            --hidden-import funasr `
            --hidden-import torch `
            --hidden-import torchaudio `
            --hidden-import sounddevice `
            --hidden-import PyQt5 `
            --hidden-import yaml `
            --hidden-import numpy `
            --hidden-import modelscope `
            realtime_gui.py

      - name: Build CLI executable
        run: |
          pyinstaller --onefile --name FunASR-Live `
            --add-data "config.yaml;." `
            --add-data "model.py;." `
            --hidden-import funasr `
            --hidden-import torch `
            --hidden-import torchaudio `
            --hidden-import sounddevice `
            --hidden-import pynput `
            --hidden-import yaml `
            --hidden-import numpy `
            --hidden-import modelscope `
            funasr_live.py

      - name: Package artifacts
        run: |
          mkdir -p release
          cp dist/FunASR-GUI.exe release/
          cp dist/FunASR-Live.exe release/
          cp config.yaml release/
          cp config_realtime.yaml release/
          cp model.py release/
          cp README.md release/
          Compress-Archive -Path release/* -DestinationPath FunASR-Live-Windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FunASR-Live-Windows-x64
          path: FunASR-Live-Windows-x64.zip

  build-macos-intel:
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          brew install portaudio

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install torch torchvision torchaudio
          pip install funasr modelscope sounddevice numpy PyYAML pynput pyperclip PyQt5 fastapi uvicorn websockets

      - name: Build GUI executable
        run: |
          pyinstaller --onefile --windowed --name FunASR-GUI \
            --add-data "config_realtime.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import PyQt5 \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            --osx-bundle-identifier com.creatsaif.funasr-gui \
            realtime_gui.py

      - name: Build CLI executable
        run: |
          pyinstaller --onefile --name FunASR-Live \
            --add-data "config.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import pynput \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            funasr_live.py

      - name: Package artifacts
        run: |
          mkdir -p release
          cp dist/FunASR-GUI release/
          cp dist/FunASR-Live release/
          cp config.yaml release/
          cp config_realtime.yaml release/
          cp model.py release/
          cp README.md release/
          cd release && zip -r ../FunASR-Live-macOS-Intel.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FunASR-Live-macOS-Intel
          path: FunASR-Live-macOS-Intel.zip

  build-macos-arm:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          brew install portaudio

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install torch torchvision torchaudio
          pip install funasr modelscope sounddevice numpy PyYAML pynput pyperclip PyQt5 fastapi uvicorn websockets

      - name: Build GUI executable
        run: |
          pyinstaller --onefile --windowed --name FunASR-GUI \
            --add-data "config_realtime.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import PyQt5 \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            --osx-bundle-identifier com.creatsaif.funasr-gui \
            realtime_gui.py

      - name: Build CLI executable
        run: |
          pyinstaller --onefile --name FunASR-Live \
            --add-data "config.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import pynput \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            funasr_live.py

      - name: Package artifacts
        run: |
          mkdir -p release
          cp dist/FunASR-GUI release/
          cp dist/FunASR-Live release/
          cp config.yaml release/
          cp config_realtime.yaml release/
          cp model.py release/
          cp README.md release/
          cd release && zip -r ../FunASR-Live-macOS-AppleSilicon.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FunASR-Live-macOS-AppleSilicon
          path: FunASR-Live-macOS-AppleSilicon.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libasound2-dev libxcb-xinerama0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install funasr modelscope sounddevice numpy PyYAML pynput pyperclip PyQt5 fastapi uvicorn websockets

      - name: Build GUI executable
        run: |
          pyinstaller --onefile --name FunASR-GUI \
            --add-data "config_realtime.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import PyQt5 \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            realtime_gui.py

      - name: Build CLI executable
        run: |
          pyinstaller --onefile --name FunASR-Live \
            --add-data "config.yaml:." \
            --add-data "model.py:." \
            --hidden-import funasr \
            --hidden-import torch \
            --hidden-import torchaudio \
            --hidden-import sounddevice \
            --hidden-import pynput \
            --hidden-import yaml \
            --hidden-import numpy \
            --hidden-import modelscope \
            funasr_live.py

      - name: Package artifacts
        run: |
          mkdir -p release
          cp dist/FunASR-GUI release/
          cp dist/FunASR-Live release/
          cp config.yaml release/
          cp config_realtime.yaml release/
          cp model.py release/
          cp README.md release/
          cd release && tar -czvf ../FunASR-Live-Linux-x64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FunASR-Live-Linux-x64
          path: FunASR-Live-Linux-x64.tar.gz

  create-release:
    needs: [build-windows, build-macos-intel, build-macos-arm, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: FunASR Live ${{ steps.version.outputs.VERSION }}
          body: |
            ## FunASR Live ${{ steps.version.outputs.VERSION }}
            
            å®æ—¶è¯­éŸ³è¯†åˆ«å·¥å…·ï¼ŒåŸºäºé˜¿é‡Œå·´å·´ FunASR æ¨¡å‹ã€‚
            
            ### åŠŸèƒ½ç‰¹æ€§
            - ğŸ¤ å®æ—¶è¯­éŸ³è¯†åˆ«
            - âŒ¨ï¸ å¿«æ·é”®è§¦å‘å½•éŸ³
            - ğŸ“‹ è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
            - ğŸ–¥ï¸ æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥
            - ğŸ”” å”¤é†’è¯æ”¯æŒ
            - ğŸŒ API æ¥å£
            
            ### ä¸‹è½½è¯´æ˜
            - **Windows**: `FunASR-Live-Windows-x64.zip`
            - **macOS (Intel)**: `FunASR-Live-macOS-Intel.zip`
            - **macOS (Apple Silicon)**: `FunASR-Live-macOS-AppleSilicon.zip`
            - **Linux**: `FunASR-Live-Linux-x64.tar.gz`
            
            ### ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `FunASR-GUI` (GUIç‰ˆæœ¬) æˆ– `FunASR-Live` (å‘½ä»¤è¡Œç‰ˆæœ¬)
            4. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹
            
            ### æ³¨æ„äº‹é¡¹
            - macOS ç”¨æˆ·éœ€è¦æˆäºˆéº¦å…‹é£å’Œè¾…åŠ©åŠŸèƒ½æƒé™
            - Windows ç”¨æˆ·å¯èƒ½éœ€è¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          draft: false
          prerelease: false
          files: |
            artifacts/FunASR-Live-Windows-x64/FunASR-Live-Windows-x64.zip
            artifacts/FunASR-Live-macOS-Intel/FunASR-Live-macOS-Intel.zip
            artifacts/FunASR-Live-macOS-AppleSilicon/FunASR-Live-macOS-AppleSilicon.zip
            artifacts/FunASR-Live-Linux-x64/FunASR-Live-Linux-x64.tar.gz
